#include <stdio.h>
#include <string.h>
#include "../poly_fill.h"
#include "../stretchy_buffer.h"
#include "minunit.h"

static char* polygon_fill_single_cell() {
  vec2d poly = {5.5, 5.5};

  vec2d* filled = fill_poly(&poly, 1);

  mu_assert("fill single cell count == 1", sb_count(filled) == 1);
  mu_assert("fill single cell",
            (filled[0].x == poly.x && filled[0].y == poly.y));
  sb_free(filled);

  return NULL;
}

static char* polygon_fill_convex() {
  vec2d poly[] = {{0.5, 0.5}, {5.5, 0.5}, {5.5, 5.5}, {0.5, 5.5}};

  vec2d expected[] = {
      {1.5, 1.5}, {2.5, 1.5}, {3.5, 1.5}, {4.5, 1.5}, {1.5, 2.5}, {2.5, 2.5},
      {3.5, 2.5}, {4.5, 2.5}, {1.5, 3.5}, {2.5, 3.5}, {3.5, 3.5}, {4.5, 3.5},
      {1.5, 4.5}, {2.5, 4.5}, {3.5, 4.5}, {4.5, 4.5}, {0.5, 0.5}, {1.5, 0.5},
      {2.5, 0.5}, {3.5, 0.5}, {4.5, 0.5}, {5.5, 0.5}, {0.5, 1.5}, {5.5, 1.5},
      {0.5, 2.5}, {5.5, 2.5}, {0.5, 3.5}, {5.5, 3.5}, {0.5, 4.5}, {5.5, 4.5},
      {0.5, 5.5}, {1.5, 5.5}, {2.5, 5.5}, {3.5, 5.5}, {4.5, 5.5}, {5.5, 5.5}};

  vec2d* filled = fill_poly(poly, 4);
  mu_assert("fill convex count", sb_count(filled) == 36);
  mu_assert("fill convex", !memcmp(expected, filled, 36 * sizeof(vec2d)));
  sb_free(filled);

  return NULL;
}

static char* polygon_fill_concave() {
  vec2d poly[] = {{5.5, 5.5},   {15.5, 10.5}, {25.5, 4.5}, {20.5, 11.5},
                  {25.5, 18.5}, {14.5, 14.5}, {4.5, 20.5}, {10.5, 14.5}};

  vec2d expected[] = {
      {7.5, 7.5},   {22.5, 7.5},  {8.5, 8.5},   {9.5, 8.5},   {20.5, 8.5},
      {21.5, 8.5},  {9.5, 9.5},   {10.5, 9.5},  {11.5, 9.5},  {18.5, 9.5},
      {19.5, 9.5},  {20.5, 9.5},  {9.5, 10.5},  {10.5, 10.5}, {11.5, 10.5},
      {12.5, 10.5}, {13.5, 10.5}, {17.5, 10.5}, {18.5, 10.5}, {19.5, 10.5},
      {10.5, 11.5}, {11.5, 11.5}, {12.5, 11.5}, {13.5, 11.5}, {14.5, 11.5},
      {15.5, 11.5}, {16.5, 11.5}, {17.5, 11.5}, {18.5, 11.5}, {19.5, 11.5},
      {10.5, 12.5}, {11.5, 12.5}, {12.5, 12.5}, {13.5, 12.5}, {14.5, 12.5},
      {15.5, 12.5}, {16.5, 12.5}, {17.5, 12.5}, {18.5, 12.5}, {19.5, 12.5},
      {11.5, 13.5}, {12.5, 13.5}, {13.5, 13.5}, {14.5, 13.5}, {15.5, 13.5},
      {16.5, 13.5}, {17.5, 13.5}, {18.5, 13.5}, {19.5, 13.5}, {20.5, 13.5},
      {11.5, 14.5}, {12.5, 14.5}, {16.5, 14.5}, {17.5, 14.5}, {18.5, 14.5},
      {19.5, 14.5}, {20.5, 14.5}, {21.5, 14.5}, {10.5, 15.5}, {11.5, 15.5},
      {19.5, 15.5}, {20.5, 15.5}, {21.5, 15.5}, {9.5, 16.5},  {22.5, 16.5},
      {24.5, 4.5},  {25.5, 4.5},  {5.5, 5.5},   {6.5, 5.5},   {22.5, 5.5},
      {23.5, 5.5},  {24.5, 5.5},  {24.5, 5.5},  {25.5, 5.5},  {5.5, 6.5},
      {6.5, 6.5},   {6.5, 6.5},   {7.5, 6.5},   {8.5, 6.5},   {21.5, 6.5},
      {22.5, 6.5},  {23.5, 6.5},  {24.5, 6.5},  {6.5, 7.5},   {8.5, 7.5},
      {9.5, 7.5},   {10.5, 7.5},  {19.5, 7.5},  {20.5, 7.5},  {21.5, 7.5},
      {23.5, 7.5},  {6.5, 8.5},   {7.5, 8.5},   {10.5, 8.5},  {11.5, 8.5},
      {12.5, 8.5},  {17.5, 8.5},  {18.5, 8.5},  {19.5, 8.5},  {22.5, 8.5},
      {23.5, 8.5},  {7.5, 9.5},   {8.5, 9.5},   {12.5, 9.5},  {13.5, 9.5},
      {14.5, 9.5},  {16.5, 9.5},  {17.5, 9.5},  {21.5, 9.5},  {22.5, 9.5},
      {8.5, 10.5},  {14.5, 10.5}, {15.5, 10.5}, {16.5, 10.5}, {20.5, 10.5},
      {21.5, 10.5}, {8.5, 11.5},  {9.5, 11.5},  {20.5, 11.5}, {9.5, 12.5},
      {20.5, 12.5}, {21.5, 12.5}, {9.5, 13.5},  {10.5, 13.5}, {21.5, 13.5},
      {22.5, 13.5}, {9.5, 14.5},  {10.5, 14.5}, {13.5, 14.5}, {14.5, 14.5},
      {15.5, 14.5}, {22.5, 14.5}, {8.5, 15.5},  {9.5, 15.5},  {12.5, 15.5},
      {13.5, 15.5}, {15.5, 15.5}, {16.5, 15.5}, {17.5, 15.5}, {18.5, 15.5},
      {22.5, 15.5}, {23.5, 15.5}, {7.5, 16.5},  {8.5, 16.5},  {10.5, 16.5},
      {11.5, 16.5}, {12.5, 16.5}, {18.5, 16.5}, {19.5, 16.5}, {20.5, 16.5},
      {21.5, 16.5}, {23.5, 16.5}, {24.5, 16.5}, {6.5, 17.5},  {7.5, 17.5},
      {8.5, 17.5},  {9.5, 17.5},  {10.5, 17.5}, {21.5, 17.5}, {22.5, 17.5},
      {23.5, 17.5}, {24.5, 17.5}, {24.5, 17.5}, {25.5, 17.5}, {5.5, 18.5},
      {6.5, 18.5},  {7.5, 18.5},  {8.5, 18.5},  {24.5, 18.5}, {25.5, 18.5},
      {4.5, 19.5},  {5.5, 19.5},  {5.5, 19.5},  {6.5, 19.5},  {7.5, 19.5},
      {4.5, 20.5},  {5.5, 20.5}};

  vec2d* filled = fill_poly(poly, 8);
  mu_assert("fill concave count", sb_count(filled) == 177);
  mu_assert("fill concave", !memcmp(expected, filled, 177 * sizeof(vec2d)));
  sb_free(filled);

  return NULL;
}

static char* test_poly_fill() {
  mu_run_test(polygon_fill_single_cell);
  mu_run_test(polygon_fill_convex);
  mu_run_test(polygon_fill_concave);
  return NULL;
}
